<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PWM Control Dashboard ü§ñ</title>
    <script src="/socket.io/socket.io.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="connection-status connecting" id="connectionStatus">
        üîÑ Connecting...
    </div>

    <div class="container">
        <div class="header slide-in">
            <h1>üéõÔ∏è PWM Control Dashboard</h1>
            <p class="subtitle">Real-time GPIO PWM control with WebSocket updates</p>
        </div>

        <!-- Quick Access Navigation -->
        <div class="control-card slide-in">
            <h2 class="card-title">üöÄ Quick Access</h2>
            <div class="action-buttons">
                <button class="action-btn" onclick="window.location.href='main-control.html'">üéõÔ∏è Main Control</button>
                <button class="action-btn secondary" onclick="window.location.href='/'">üè† Home</button>
            </div>
        </div>

        <!-- Individual GPIO Dashboards -->
        <div class="control-card slide-in">
            <h2 class="card-title">‚öôÔ∏è Individual GPIO Controls</h2>
            <div class="gpio-dashboards" id="gpioDashboards">
                <!-- Dashboard 1 -->
                <div class="gpio-dashboard" data-dashboard="1">
                    <div class="dashboard-header">
                        <span class="dashboard-title">üîå GPIO #1</span>
                        <select class="gpio-selector" data-pin-selector="1">
                            <option value="18">GPIO 18</option>
                            <option value="12">GPIO 12</option>
                            <option value="13">GPIO 13</option>
                            <option value="19">GPIO 19</option>
                            <option value="4">GPIO 4</option>
                            <option value="14">GPIO 14</option>
                            <option value="15">GPIO 15</option>
                            <option value="17">GPIO 17</option>
                        </select>
                    </div>
                    
                    <div class="gpio-status">
                        <div class="status-indicator" data-indicator="1"></div>
                        <span class="status-text" data-status="1">0 PWM (0%)</span>
                    </div>
                    
                    <input type="range" class="dashboard-slider" data-slider="1" min="0" max="255" value="0">
                    
                    <div class="preset-buttons">
                        <button class="preset-btn" data-preset="1" data-value="64">25%</button>
                        <button class="preset-btn" data-preset="1" data-value="128">50%</button>
                        <button class="preset-btn" data-preset="1" data-value="191">75%</button>
                        <button class="preset-btn" data-preset="1" data-value="255">100%</button>
                    </div>
                </div>

                <!-- Dashboard 2 -->
                <div class="gpio-dashboard" data-dashboard="2">
                    <div class="dashboard-header">
                        <span class="dashboard-title">üîå GPIO #2</span>
                        <select class="gpio-selector" data-pin-selector="2">
                            <option value="12" selected>GPIO 12</option>
                            <option value="18">GPIO 18</option>
                            <option value="13">GPIO 13</option>
                            <option value="19">GPIO 19</option>
                            <option value="4">GPIO 4</option>
                            <option value="14">GPIO 14</option>
                            <option value="15">GPIO 15</option>
                            <option value="17">GPIO 17</option>
                        </select>
                    </div>
                    
                    <div class="gpio-status">
                        <div class="status-indicator" data-indicator="2"></div>
                        <span class="status-text" data-status="2">0 PWM (0%)</span>
                    </div>
                    
                    <input type="range" class="dashboard-slider" data-slider="2" min="0" max="255" value="0">
                    
                    <div class="preset-buttons">
                        <button class="preset-btn" data-preset="2" data-value="64">25%</button>
                        <button class="preset-btn" data-preset="2" data-value="128">50%</button>
                        <button class="preset-btn" data-preset="2" data-value="191">75%</button>
                        <button class="preset-btn" data-preset="2" data-value="255">100%</button>
                    </div>
                </div>

                <!-- Dashboard 3 -->
                <div class="gpio-dashboard" data-dashboard="3">
                    <div class="dashboard-header">
                        <span class="dashboard-title">üîå GPIO #3</span>
                        <select class="gpio-selector" data-pin-selector="3">
                            <option value="13" selected>GPIO 13</option>
                            <option value="18">GPIO 18</option>
                            <option value="12">GPIO 12</option>
                            <option value="19">GPIO 19</option>
                            <option value="4">GPIO 4</option>
                            <option value="14">GPIO 14</option>
                            <option value="15">GPIO 15</option>
                            <option value="17">GPIO 17</option>
                        </select>
                    </div>
                    
                    <div class="gpio-status">
                        <div class="status-indicator" data-indicator="3"></div>
                        <span class="status-text" data-status="3">0 PWM (0%)</span>
                    </div>
                    
                    <input type="range" class="dashboard-slider" data-slider="3" min="0" max="255" value="0">
                    
                    <div class="preset-buttons">
                        <button class="preset-btn" data-preset="3" data-value="64">25%</button>
                        <button class="preset-btn" data-preset="3" data-value="128">50%</button>
                        <button class="preset-btn" data-preset="3" data-value="191">75%</button>
                        <button class="preset-btn" data-preset="3" data-value="255">100%</button>
                    </div>
                </div>

                <!-- Dashboard 4 -->
                <div class="gpio-dashboard" data-dashboard="4">
                    <div class="dashboard-header">
                        <span class="dashboard-title">üîå GPIO #4</span>
                        <select class="gpio-selector" data-pin-selector="4">
                            <option value="19" selected>GPIO 19</option>
                            <option value="18">GPIO 18</option>
                            <option value="12">GPIO 12</option>
                            <option value="13">GPIO 13</option>
                            <option value="4">GPIO 4</option>
                            <option value="14">GPIO 14</option>
                            <option value="15">GPIO 15</option>
                            <option value="17">GPIO 17</option>
                        </select>
                    </div>
                    
                    <div class="gpio-status">
                        <div class="status-indicator" data-indicator="4"></div>
                        <span class="status-text" data-status="4">0 PWM (0%)</span>
                    </div>
                    
                    <input type="range" class="dashboard-slider" data-slider="4" min="0" max="255" value="0">
                    
                    <div class="preset-buttons">
                        <button class="preset-btn" data-preset="4" data-value="64">25%</button>
                        <button class="preset-btn" data-preset="4" data-value="128">50%</button>
                        <button class="preset-btn" data-preset="4" data-value="191">75%</button>
                        <button class="preset-btn" data-preset="4" data-value="255">100%</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- RPM Controller -->
        <div class="control-card slide-in">
            <h2 class="card-title">üéØ RPM Controller (Closed-Loop)</h2>
            <div class="rpm-control">
                <div class="control-row">
                    <span class="control-label">Target Pin:</span>
                    <select id="rpmControlPin">
                        <option value="19" selected>GPIO 19 (Front Left)</option>
                        <option value="13">GPIO 13 (Front Right)</option>
                        <option value="12">GPIO 12 (Rear Right)</option>
                        <option value="18">GPIO 18 (Rear Left)</option>
                    </select>
                    <span class="control-label">Sensor:</span>
                    <select id="rpmSensorSelect">
                        <option value="1" selected>Sensor #1 (GPIO 23 - Front Left)</option>
                        <option value="2">Sensor #2 (GPIO 22 - Front Right)</option>
                        <option value="3">Sensor #3 (GPIO 4 - Rear Right)</option>
                        <option value="4">Sensor #4 (GPIO 27 - Rear Left)</option>
                    </select>
                </div>
                
                <div class="rpm-display-grid">
                    <div class="rpm-metric">
                        <div class="metric-label">Target RPM</div>
                        <div class="metric-value" id="targetRpmDisplay">0</div>
                    </div>
                    <div class="rpm-metric">
                        <div class="metric-label">Current RPM</div>
                        <div class="metric-value" id="currentRpmDisplay">0</div>
                    </div>
                    <div class="rpm-metric">
                        <div class="metric-label">PWM Output</div>
                        <div class="metric-value" id="rpmPwmDisplay">0 (0%)</div>
                    </div>
                    <div class="rpm-metric">
                        <div class="metric-label">Error</div>
                        <div class="metric-value" id="rpmErrorDisplay">0</div>
                    </div>
                </div>
                
                <div class="control-row">
                    <span class="control-label">Desired RPM:</span>
                    <input type="range" id="rpmSlider" class="pwm-slider" min="0" max="100" value="0" step="1">
                    <input type="number" id="rpmInput" value="0" min="0" max="100" step="1">
                    <span>RPM</span>
                </div>
                
                <div class="control-row">
                    <span class="control-label">Control Gain:</span>
                    <input type="range" id="controlGain" min="0.5" max="5.0" step="0.1" value="2.0">
                    <span id="gainDisplay">2.0</span>
                </div>
                
                <div class="action-buttons">
                    <button class="action-btn" id="startRpmControl">üéØ Start RPM Control</button>
                    <button class="action-btn secondary" id="stopRpmControl">‚èπÔ∏è Stop Control</button>
                    <button class="action-btn" id="rpmPreset15">15 RPM</button>
                    <button class="action-btn" id="rpmPreset30">30 RPM</button>
                    <button class="action-btn" id="rpmPreset50">50 RPM</button>
                </div>
                
                <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 8px; font-size: 0.9rem;">
                    <div class="rpm-status" id="rpmStatus">
                        <strong>Status:</strong> <span style="color: #6c757d;">Stopped</span><br>
                        <strong>Mode:</strong> Server-side closed-loop control (45 pulses/rotation)<br>
                        <strong>Control:</strong> Aggressive PID tuning (kp=2.5, ki=0.35, kd=0.04)<br>
                        <strong>Sensor:</strong> Interrupt-based detection with rolling window<br>
                        <strong>Update Rate:</strong> 100ms backend control loop
                    </div>
                </div>
            </div>
        </div>



        <!-- Sensor Input Monitoring -->
        <div class="control-card slide-in">
            <h2 class="card-title">üì° Sensor Input Monitoring</h2>
            <div class="gpio-dashboards" id="sensorDashboards">
                <!-- Sensor 1 (Default to GPIO 23 for wheel rotation testing) -->
                <div class="gpio-dashboard sensor-dashboard" data-sensor="1">
                    <div class="dashboard-header">
                        <span class="dashboard-title">üìä Sensor #1 (Front Left)</span>
                        <select class="sensor-selector" data-sensor-pin="1">
                            <option value="23" selected>GPIO 23 (Front Left) üîÑ</option>
                            <option value="22">GPIO 22 (Front Right)</option>
                            <option value="4">GPIO 4 (Rear Right)</option>
                            <option value="27">GPIO 27 (Rear Left)</option>
                            <option value="2">GPIO 2 (Input)</option>
                            <option value="3">GPIO 3 (Input)</option>
                            <option value="17">GPIO 17 (Input)</option>
                            <option value="24">GPIO 24 (Input)</option>
                        </select>
                    </div>
                    
                    <div class="sensor-status">
                        <div class="status-indicator sensor-indicator" data-sensor-indicator="1"></div>
                        <span class="status-text">Front Left Wheel - GPIO 23</span>
                    </div>
                    
                    <div class="sensor-readings">
                        <div class="sensor-metric">
                            <div class="metric-label">Total Pulses</div>
                            <div class="metric-value" id="sensorPulses1">0</div>
                        </div>
                        <div class="sensor-metric">
                            <div class="metric-label">Pulses/sec</div>
                            <div class="metric-value" id="sensorRate1">0</div>
                        </div>
                        <div class="sensor-metric">
                            <div class="metric-label">Last Pulse</div>
                            <div class="metric-value" id="sensorTime1">--:--</div>
                        </div>
                    </div>
                    
                    <div class="sensor-controls">
                        <button class="action-btn secondary sensor-reset" data-reset-sensor="1">üîÑ Reset</button>
                        <button class="action-btn sensor-enable" data-enable-sensor="1">üì° Enable</button>
                    </div>
                </div>

                <!-- Sensor 2 -->
                <div class="gpio-dashboard sensor-dashboard" data-sensor="2">
                    <div class="dashboard-header">
                        <span class="dashboard-title">üìä Sensor #2 (Front Right)</span>
                        <select class="sensor-selector" data-sensor-pin="2">
                            <option value="22" selected>GPIO 22 (Front Right)</option>
                            <option value="23">GPIO 23 (Front Left)</option>
                            <option value="4">GPIO 4 (Rear Right)</option>
                            <option value="27">GPIO 27 (Rear Left)</option>
                            <option value="2">GPIO 2 (Input)</option>
                            <option value="3">GPIO 3 (Input)</option>
                            <option value="17">GPIO 17 (Input)</option>
                            <option value="24">GPIO 24 (Input)</option>
                        </select>
                    </div>
                    
                    <div class="sensor-status">
                        <div class="status-indicator sensor-indicator" data-sensor-indicator="2"></div>
                        <span class="status-text">Front Right Wheel - GPIO 22</span>
                    </div>
                    
                    <div class="sensor-readings">
                        <div class="sensor-metric">
                            <div class="metric-label">Total Pulses</div>
                            <div class="metric-value" id="sensorPulses2">0</div>
                        </div>
                        <div class="sensor-metric">
                            <div class="metric-label">Pulses/sec</div>
                            <div class="metric-value" id="sensorRate2">0</div>
                        </div>
                        <div class="sensor-metric">
                            <div class="metric-label">Last Pulse</div>
                            <div class="metric-value" id="sensorTime2">--:--</div>
                        </div>
                    </div>
                    
                    <div class="sensor-controls">
                        <button class="action-btn secondary sensor-reset" data-reset-sensor="2">üîÑ Reset</button>
                        <button class="action-btn sensor-enable" data-enable-sensor="2">üì° Enable</button>
                    </div>
                </div>

                <!-- Sensor 3 -->
                <div class="gpio-dashboard sensor-dashboard" data-sensor="3">
                    <div class="dashboard-header">
                        <span class="dashboard-title">üìä Sensor #3 (Rear Right)</span>
                        <select class="sensor-selector" data-sensor-pin="3">
                            <option value="4" selected>GPIO 4 (Rear Right)</option>
                            <option value="23">GPIO 23 (Front Left)</option>
                            <option value="22">GPIO 22 (Front Right)</option>
                            <option value="27">GPIO 27 (Rear Left)</option>
                            <option value="2">GPIO 2 (Input)</option>
                            <option value="3">GPIO 3 (Input)</option>
                            <option value="17">GPIO 17 (Input)</option>
                            <option value="24">GPIO 24 (Input)</option>
                        </select>
                    </div>
                    
                    <div class="sensor-status">
                        <div class="status-indicator sensor-indicator" data-sensor-indicator="3"></div>
                        <span class="status-text">Rear Right Wheel - GPIO 4</span>
                    </div>
                    
                    <div class="sensor-readings">
                        <div class="sensor-metric">
                            <div class="metric-label">Total Pulses</div>
                            <div class="metric-value" id="sensorPulses3">0</div>
                        </div>
                        <div class="sensor-metric">
                            <div class="metric-label">Pulses/sec</div>
                            <div class="metric-value" id="sensorRate3">0</div>
                        </div>
                        <div class="sensor-metric">
                            <div class="metric-label">Last Pulse</div>
                            <div class="metric-value" id="sensorTime3">--:--</div>
                        </div>
                    </div>
                    
                    <div class="sensor-controls">
                        <button class="action-btn secondary sensor-reset" data-reset-sensor="3">üîÑ Reset</button>
                        <button class="action-btn sensor-enable" data-enable-sensor="3">üì° Enable</button>
                    </div>
                </div>

                <!-- Sensor 4 -->
                <div class="gpio-dashboard sensor-dashboard" data-sensor="4">
                    <div class="dashboard-header">
                        <span class="dashboard-title">üìä Sensor #4 (Rear Left)</span>
                        <select class="sensor-selector" data-sensor-pin="4">
                            <option value="27" selected>GPIO 27 (Rear Left)</option>
                            <option value="23">GPIO 23 (Front Left)</option>
                            <option value="22">GPIO 22 (Front Right)</option>
                            <option value="4">GPIO 4 (Rear Right)</option>
                            <option value="2">GPIO 2 (Input)</option>
                            <option value="3">GPIO 3 (Input)</option>
                            <option value="17">GPIO 17 (Input)</option>
                            <option value="24">GPIO 24 (Input)</option>
                        </select>
                    </div>
                    
                    <div class="sensor-status">
                        <div class="status-indicator sensor-indicator" data-sensor-indicator="4"></div>
                        <span class="status-text">Rear Left Wheel - GPIO 27</span>
                    </div>
                    
                    <div class="sensor-readings">
                        <div class="sensor-metric">
                            <div class="metric-label">Total Pulses</div>
                            <div class="metric-value" id="sensorPulses4">0</div>
                        </div>
                        <div class="sensor-metric">
                            <div class="metric-label">Pulses/sec</div>
                            <div class="metric-value" id="sensorRate4">0</div>
                        </div>
                        <div class="sensor-metric">
                            <div class="metric-label">Last Pulse</div>
                            <div class="metric-value" id="sensorTime4">--:--</div>
                        </div>
                    </div>
                    
                    <div class="sensor-controls">
                        <button class="action-btn secondary sensor-reset" data-reset-sensor="4">üîÑ Reset</button>
                        <button class="action-btn sensor-enable" data-enable-sensor="4">üì° Enable</button>
                    </div>
                </div>
            </div>
            
            <div class="action-buttons">
                <button class="action-btn" id="resetAllSensors">üîÑ Reset All Sensors</button>
                <button class="action-btn" id="enableAllSensors">üì° Enable All</button>
                <button class="action-btn secondary" id="disableAllSensors">üö´ Disable All</button>
            </div>
            
            <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 8px; font-size: 0.9rem; color: #666;">
                <strong>üìã Active Sensor Pins:</strong>
                <div id="activeSensorsList">GPIO 23 (FL), GPIO 22 (FR), GPIO 4 (RR), GPIO 27 (RL)</div>
            </div>
        </div>


    </div>

    <script>
        // Initialize Socket.IO connection
        const socket = io();
        
        // DOM elements
        const connectionStatus = document.getElementById('connectionStatus');
        

        
        // Sensor elements
        const activeSensorsList = document.getElementById('activeSensorsList');

        // GPIO dashboard state (Updated for your wheel mapping)
        const dashboardState = {
            1: { pin: 19, value: 0 }, // Front Left
            2: { pin: 13, value: 0 }, // Front Right  
            3: { pin: 12, value: 0 }, // Rear Right
            4: { pin: 18, value: 0 }  // Rear Left
        };

        // Sensor state (Updated for your wheel mapping)
        const sensorState = {
            1: { pin: 23, enabled: false, pulses: 0, rate: 0, lastPulse: null }, // Front Left 
            2: { pin: 22, enabled: false, pulses: 0, rate: 0, lastPulse: null }, // Front Right
            3: { pin: 4, enabled: false, pulses: 0, rate: 0, lastPulse: null },  // Rear Right
            4: { pin: 27, enabled: false, pulses: 0, rate: 0, lastPulse: null }  // Rear Left
        };



        // RPM Controller state (frontend - for display only)
        const rpmController = {
            active: false,
            targetRPM: 0,
            currentRPM: 0,
            currentPWM: 0,
            error: 0,
            controlPin: 19, // Front Left wheel by default
            sensorNumber: 1, // Front Left sensor by default
            gain: 2.0
        };

        // GPIO pin management - track used pins to prevent conflicts
        const availablePins = {
            // All available GPIO pins on Raspberry Pi
            all: [2, 3, 4, 12, 13, 14, 15, 17, 18, 19, 22, 23, 24, 27],
            // Hardware PWM pins (preferred for PWM output)
            hardwarePWM: [12, 13, 18, 19],
            // Software PWM pins
            softwarePWM: [4, 14, 15, 17],
            // Good input pins (no special functions)
            inputPins: [2, 3, 22, 23, 24, 27]
        };

        // Get currently used PWM pins
        function getUsedPWMPins() {
            return Object.values(dashboardState).map(state => state.pin);
        }

        // Get currently used sensor pins
        function getUsedSensorPins() {
            return Object.values(sensorState).map(state => state.pin);
        }

        // Get available pins for sensor input (exclude PWM pins)
        function getAvailableSensorPins() {
            const usedPWMPins = getUsedPWMPins();
            return availablePins.all.filter(pin => !usedPWMPins.includes(pin));
        }

        // Get available pins for PWM output (exclude sensor pins)
        function getAvailablePWMPins() {
            const usedSensorPins = getUsedSensorPins();
            return availablePins.all.filter(pin => !usedSensorPins.includes(pin));
        }

        // Update sensor pin options based on available pins
        function updateSensorPinOptions() {
            const availableSensorPins = getAvailableSensorPins();
            
            document.querySelectorAll('.sensor-selector').forEach(selector => {
                const currentValue = parseInt(selector.value);
                const sensorNumber = selector.dataset.sensorPin;
                
                // Store current selection
                const wasSelected = currentValue;
                
                // Clear and rebuild options
                selector.innerHTML = '';
                
                // Add current pin if it's still valid (not used by PWM)
                const usedPWMPins = getUsedPWMPins();
                if (!usedPWMPins.includes(currentValue)) {
                    const option = document.createElement('option');
                    option.value = currentValue;
                    option.textContent = `GPIO ${currentValue} (Input)`;
                    option.selected = true;
                    selector.appendChild(option);
                }
                
                // Add other available pins
                availableSensorPins.forEach(pin => {
                    if (pin !== currentValue) {
                        const option = document.createElement('option');
                        option.value = pin;
                        option.textContent = `GPIO ${pin} (Input)`;
                        selector.appendChild(option);
                    }
                });
                
                // If current pin is no longer available, select first available
                if (usedPWMPins.includes(currentValue) && availableSensorPins.length > 0) {
                    const newPin = availableSensorPins[0];
                    selector.value = newPin;
                    
                    // Update sensor state
                    sensorState[sensorNumber].pin = newPin;
                    log(`Sensor ${sensorNumber}: Pin conflict resolved, moved to GPIO ${newPin}`, 'WARNING');
                }
            });
        }

        // Update PWM pin options based on available pins
        function updatePWMPinOptions() {
            const availablePWMPins = getAvailablePWMPins();
            const hardwarePWM = availablePins.hardwarePWM.filter(pin => availablePWMPins.includes(pin));
            const softwarePWM = availablePins.softwarePWM.filter(pin => availablePWMPins.includes(pin));
            
            // Update main PWM selector
            const mainSelector = document.getElementById('mainPin');
            const currentMainValue = parseInt(mainSelector.value);
            
            mainSelector.innerHTML = '';
            
            // Add hardware PWM options first
            hardwarePWM.forEach(pin => {
                const option = document.createElement('option');
                option.value = pin;
                option.textContent = `GPIO ${pin} (Hardware PWM)`;
                if (pin === currentMainValue) option.selected = true;
                mainSelector.appendChild(option);
            });
            
            // Add software PWM options
            softwarePWM.forEach(pin => {
                const option = document.createElement('option');
                option.value = pin;
                option.textContent = `GPIO ${pin} (Software PWM)`;
                if (pin === currentMainValue) option.selected = true;
                mainSelector.appendChild(option);
            });
            
            // Update dashboard selectors
            document.querySelectorAll('.gpio-selector').forEach(selector => {
                const currentValue = parseInt(selector.value);
                const dashboardNumber = selector.dataset.pinSelector;
                
                selector.innerHTML = '';
                
                // Add current pin if still available
                const usedSensorPins = getUsedSensorPins();
                if (!usedSensorPins.includes(currentValue)) {
                    const option = document.createElement('option');
                    option.value = currentValue;
                    option.textContent = `GPIO ${currentValue}`;
                    option.selected = true;
                    selector.appendChild(option);
                }
                
                // Add other available pins
                availablePWMPins.forEach(pin => {
                    if (pin !== currentValue) {
                        const option = document.createElement('option');
                        option.value = pin;
                        option.textContent = `GPIO ${pin}`;
                        selector.appendChild(option);
                    }
                });
                
                // If current pin is no longer available, select first available
                if (usedSensorPins.includes(currentValue) && availablePWMPins.length > 0) {
                    const newPin = availablePWMPins[0];
                    selector.value = newPin;
                    
                    // Update dashboard state
                    dashboardState[dashboardNumber].pin = newPin;
                    log(`PWM Dashboard ${dashboardNumber}: Pin conflict resolved, moved to GPIO ${newPin}`, 'WARNING');
                }
            });
        }

        // Initialize pin options on page load
        function initializePinOptions() {
            log('Initializing GPIO pin options with conflict prevention', 'INFO');
            
            // Update all pin selectors to show only available options
            updateSensorPinOptions();
            updatePWMPinOptions();
            
            log('GPIO pin conflict prevention active', 'SUCCESS');
        }

        // Utility function to log messages (simplified - console only)
        function log(message, type = 'INFO') {
            console.log(`[${type}] ${message}`);
        }

        // WebSocket connection handlers
        socket.on('connect', () => {
            log('Connected to WebSocket server', 'WEBSOCKET');
            connectionStatus.textContent = 'üü¢ Connected';
            connectionStatus.className = 'connection-status connected';
        });

        socket.on('disconnect', () => {
            log('Disconnected from WebSocket server', 'WEBSOCKET');
            connectionStatus.textContent = 'üî¥ Disconnected';
            connectionStatus.className = 'connection-status disconnected';
        });

        // Real-time PWM updates via WebSocket
        socket.on('pwmUpdate', (data) => {
            log(`PWM Update: GPIO ${data.pin} set to ${data.dutyCycle} (${Math.round((data.dutyCycle/255)*100)}%)`, 'WEBSOCKET');
            updateDashboardDisplay(data.pin, data.dutyCycle);
        });

        // Real-time sensor updates via WebSocket
        socket.on('sensorPulse', (data) => {
            const { sensor, pin, pulses, rate, timestamp } = data;
            log(`üîÑ WHEEL ROTATION: Sensor ${sensor} (GPIO ${pin}) - Total: ${pulses}, Rate: ${rate}/sec`, 'WEBSOCKET');
            updateSensorDisplay(sensor, pulses, rate, timestamp);
        });

        // Real-time RPM control status updates from server
        socket.on('rpmStatus', (data) => {
            const { active, targetRPM, currentRPM, currentPWM, error, controlPin, sensorNumber } = data;
            
            // Update local state
            rpmController.active = active;
            rpmController.targetRPM = targetRPM;
            rpmController.currentRPM = currentRPM;
            rpmController.currentPWM = currentPWM;
            rpmController.error = error;
            rpmController.controlPin = controlPin;
            rpmController.sensorNumber = sensorNumber;
            
            // Update display
            updateRPMDisplay();
            
            // Update status indicator
            updateRPMStatusDisplay();
        });

        socket.on('sensorUpdate', (data) => {
            log(`Sensor Update: ${data.message}`, 'WEBSOCKET');
            if (data.sensorStates) {
                // Update all sensor states
                Object.keys(data.sensorStates).forEach(sensor => {
                    const state = data.sensorStates[sensor];
                    sensorState[sensor] = { ...sensorState[sensor], ...state };
                    updateSensorDisplay(sensor, state.pulses, state.rate, state.lastPulse);
                });
            }
        });

        // Send PWM command via WebSocket and HTTP
        async function setPWM(pin, dutyCycle, frequency = 1000) {
            // Send via WebSocket for real-time updates
            socket.emit('setPWM', { pin, dutyCycle, frequency });
            
            // Also send via HTTP for server-side processing
            try {
                const response = await fetch('/api/pwm/set', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ pin, dutyCycle, frequency, enabled: dutyCycle > 0 })
                });
                
                const data = await response.json();
                if (data.success) {
                    log(`PWM Set: GPIO ${pin} = ${dutyCycle} (${data.dutyPercentage}%)`, 'SUCCESS');
                    updateDashboardDisplay(pin, dutyCycle);
                } else {
                    log(`PWM Set Failed: ${data.error}`, 'ERROR');
                }
            } catch (error) {
                log(`PWM Request Error: ${error.message}`, 'ERROR');
            }
        }

        // Update dashboard display for a specific pin
        function updateDashboardDisplay(pin, dutyCycle) {
            const percentage = Math.round((dutyCycle / 255) * 100);
            
            // Main control has been moved to separate file
            
            // Update appropriate dashboard
            for (let dashboard in dashboardState) {
                if (dashboardState[dashboard].pin === pin) {
                    dashboardState[dashboard].value = dutyCycle;
                    
                    const statusElement = document.querySelector(`[data-status="${dashboard}"]`);
                    const indicatorElement = document.querySelector(`[data-indicator="${dashboard}"]`);
                    const sliderElement = document.querySelector(`[data-slider="${dashboard}"]`);
                    
                    if (statusElement) {
                        statusElement.textContent = `${dutyCycle} PWM (${percentage}%)`;
                    }
                    
                    if (indicatorElement) {
                        if (dutyCycle > 0) {
                            indicatorElement.classList.add('active');
                        } else {
                            indicatorElement.classList.remove('active');
                        }
                    }
                    
                    if (sliderElement) {
                        sliderElement.value = dutyCycle;
                    }
                    
                    // Update preset button states
                    updatePresetButtons(dashboard, dutyCycle);
                    break;
                }
            }
        }

        // Update preset button states
        function updatePresetButtons(dashboard, dutyCycle) {
            const presetButtons = document.querySelectorAll(`[data-preset="${dashboard}"]`);
            presetButtons.forEach(btn => {
                const presetValue = parseInt(btn.dataset.value);
                if (Math.abs(dutyCycle - presetValue) <= 2) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }







        // Update active sensors list display
        function updateActiveSensorsList() {
            const sensors = Object.values(sensorState).map(state => `GPIO ${state.pin}`);
            activeSensorsList.textContent = sensors.join(', ');
        }

        // RPM Controller Functions (Server-side API calls)
        async function startRPMControl() {
            try {
                const response = await fetch('/api/rpm-control/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        targetRPM: rpmController.targetRPM,
                        controlPin: rpmController.controlPin,
                        sensorNumber: rpmController.sensorNumber,
                        gain: rpmController.gain
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    log(`RPM Control Started: ${data.message}`, 'SUCCESS');
                } else {
                    log(`RPM Control Failed: ${data.error}`, 'ERROR');
                }
            } catch (error) {
                log(`RPM Control Error: ${error.message}`, 'ERROR');
            }
        }

        async function stopRPMControl() {
            try {
                const response = await fetch('/api/rpm-control/stop', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const data = await response.json();
                if (data.success) {
                    log('RPM Control Stopped', 'INFO');
                } else {
                    log(`RPM Control Stop Failed: ${data.error}`, 'ERROR');
                }
            } catch (error) {
                log(`RPM Control Stop Error: ${error.message}`, 'ERROR');
            }
        }

        async function setTargetRPM(rpm) {
            try {
                const response = await fetch('/api/rpm-control/set-rpm', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ targetRPM: rpm })
                });
                
                const data = await response.json();
                if (data.success) {
                    log(`Target RPM updated: ${rpm} RPM`, 'INFO');
                } else {
                    log(`RPM Update Failed: ${data.error}`, 'ERROR');
                }
            } catch (error) {
                log(`RPM Update Error: ${error.message}`, 'ERROR');
            }
        }

        async function updateRPMParams() {
            try {
                const response = await fetch('/api/rpm-control/set-params', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        gain: rpmController.gain,
                        controlPin: rpmController.controlPin,
                        sensorNumber: rpmController.sensorNumber
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    log('RPM Control parameters updated', 'INFO');
                } else {
                    log(`RPM Params Update Failed: ${data.error}`, 'ERROR');
                }
            } catch (error) {
                log(`RPM Params Error: ${error.message}`, 'ERROR');
            }
        }

        function updateRPMDisplay() {
            document.getElementById('targetRpmDisplay').textContent = rpmController.targetRPM;
            document.getElementById('currentRpmDisplay').textContent = rpmController.currentRPM;
            document.getElementById('rpmPwmDisplay').textContent = `${rpmController.currentPWM} (${Math.round((rpmController.currentPWM/255)*100)}%)`;
            document.getElementById('rpmErrorDisplay').textContent = rpmController.error;
            
            // Color coding based on error
            const errorElement = document.getElementById('rpmErrorDisplay');
            if (Math.abs(rpmController.error) < 2) {
                errorElement.style.color = '#28a745'; // Green - good
            } else if (Math.abs(rpmController.error) < 5) {
                errorElement.style.color = '#ffc107'; // Yellow - okay
            } else {
                errorElement.style.color = '#dc3545'; // Red - large error
            }
        }

        function updateRPMStatusDisplay() {
            const statusElement = document.getElementById('rpmStatus');
            
            if (rpmController.active) {
                statusElement.innerHTML = `
                    <strong>Status:</strong> <span style="color: #28a745;">Active - Aggressive PID Control on GPIO ${rpmController.controlPin}</span><br>
                    <strong>Mode:</strong> Server-side closed-loop control (45 pulses/rotation)<br>
                    <strong>Control:</strong> Aggressive PID tuning (kp=2.5, ki=0.35, kd=0.04)<br>
                    <strong>Sensor:</strong> Interrupt-based detection with rolling window<br>
                    <strong>Update Rate:</strong> 100ms backend control loop
                `;
                statusElement.classList.add('active');
            } else {
                statusElement.innerHTML = `
                    <strong>Status:</strong> <span style="color: #6c757d;">Stopped</span><br>
                    <strong>Mode:</strong> Server-side closed-loop control (45 pulses/rotation)<br>
                    <strong>Control:</strong> Aggressive PID tuning (kp=2.5, ki=0.35, kd=0.04)<br>
                    <strong>Sensor:</strong> Interrupt-based detection with rolling window<br>
                    <strong>Update Rate:</strong> 100ms backend control loop
                `;
                statusElement.classList.remove('active');
            }
        }



        // Update sensor display for real wheel rotation
        function updateSensorDisplay(sensor, pulses, rate, timestamp) {
            const pulsesElement = document.getElementById(`sensorPulses${sensor}`);
            const rateElement = document.getElementById(`sensorRate${sensor}`);
            const timeElement = document.getElementById(`sensorTime${sensor}`);
            const indicatorElement = document.querySelector(`[data-sensor-indicator="${sensor}"]`);
            
            if (pulsesElement) {
                pulsesElement.textContent = pulses;
                // Green color for real GPIO wheel rotation
                pulsesElement.style.color = '#28a745';
                pulsesElement.classList.add('pulse-animation');
                setTimeout(() => pulsesElement.classList.remove('pulse-animation'), 300);
            }
            
            if (rateElement) {
                rateElement.textContent = rate;
                // Green color for real GPIO wheel rotation
                rateElement.style.color = '#28a745';
            }
            
            if (timeElement && timestamp) {
                const time = new Date(timestamp).toLocaleTimeString();
                timeElement.textContent = time;
            }
            
            if (indicatorElement) {
                if (rate > 0) {
                    indicatorElement.classList.add('active');
                    // Green glow for wheel rotation detection
                    indicatorElement.style.boxShadow = '0 0 15px rgba(40, 167, 69, 1.0)';
                }
                
                // Remove active class after 1 second if no more pulses
                setTimeout(() => {
                    if (sensorState[sensor].rate === 0) {
                        indicatorElement.classList.remove('active');
                        indicatorElement.style.boxShadow = '';
                    }
                }, 1000);
            }
            
            // Update local state
            sensorState[sensor].pulses = pulses;
            sensorState[sensor].rate = rate;
            sensorState[sensor].lastPulse = timestamp;
        }

        // Enable sensor monitoring
        async function enableSensor(sensor) {
            const pin = sensorState[sensor].pin;
            
            try {
                const response = await fetch('/api/sensors/enable', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sensor, pin })
                });
                
                const data = await response.json();
                if (data.success) {
                    sensorState[sensor].enabled = true;
                    log(`Sensor ${sensor} (GPIO ${pin}) enabled`, 'SUCCESS');
                    
                    // Update button state
                    const button = document.querySelector(`[data-enable-sensor="${sensor}"]`);
                    if (button) {
                        button.textContent = 'üü¢ Enabled';
                        button.classList.add('enabled');
                    }
                } else {
                    log(`Failed to enable sensor ${sensor}: ${data.error}`, 'ERROR');
                }
            } catch (error) {
                log(`Sensor enable error: ${error.message}`, 'ERROR');
            }
        }

        // Disable sensor monitoring
        async function disableSensor(sensor) {
            const pin = sensorState[sensor].pin;
            
            try {
                const response = await fetch('/api/sensors/disable', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sensor, pin })
                });
                
                const data = await response.json();
                if (data.success) {
                    sensorState[sensor].enabled = false;
                    log(`Sensor ${sensor} (GPIO ${pin}) disabled`, 'INFO');
                    
                    // Update button state
                    const button = document.querySelector(`[data-enable-sensor="${sensor}"]`);
                    if (button) {
                        button.textContent = 'üì° Enable';
                        button.classList.remove('enabled');
                    }
                    
                    // Clear indicator
                    const indicator = document.querySelector(`[data-sensor-indicator="${sensor}"]`);
                    if (indicator) {
                        indicator.classList.remove('active');
                    }
                } else {
                    log(`Failed to disable sensor ${sensor}: ${data.error}`, 'ERROR');
                }
            } catch (error) {
                log(`Sensor disable error: ${error.message}`, 'ERROR');
            }
        }

        // Reset sensor counters
        async function resetSensor(sensor) {
            const pin = sensorState[sensor].pin;
            
            try {
                const response = await fetch('/api/sensors/reset', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sensor, pin })
                });
                
                const data = await response.json();
                if (data.success) {
                    log(`Sensor ${sensor} (GPIO ${pin}) reset`, 'INFO');
                    updateSensorDisplay(sensor, 0, 0, null);
                } else {
                    log(`Failed to reset sensor ${sensor}: ${data.error}`, 'ERROR');
                }
            } catch (error) {
                log(`Sensor reset error: ${error.message}`, 'ERROR');
            }
        }









        // Dashboard slider handlers
        document.querySelectorAll('.dashboard-slider').forEach(slider => {
            slider.addEventListener('input', (e) => {
                const dashboard = e.target.dataset.slider;
                const pin = dashboardState[dashboard].pin;
                const dutyCycle = parseInt(e.target.value);
                
                // Update local state immediately for UI responsiveness
                dashboardState[dashboard].value = dutyCycle;
                updateDashboardDisplay(pin, dutyCycle);
                
                // Debounce the PWM calls
                clearTimeout(slider.debounceTimer);
                slider.debounceTimer = setTimeout(() => {
                    setPWM(pin, dutyCycle);
                }, 100);
            });
        });

        // GPIO pin selector handlers
        document.querySelectorAll('.gpio-selector').forEach(selector => {
            selector.addEventListener('change', (e) => {
                const dashboard = e.target.dataset.pinSelector;
                const newPin = parseInt(e.target.value);
                const oldPin = dashboardState[dashboard].pin;
                
                log(`Dashboard ${dashboard}: Changed from GPIO ${oldPin} to GPIO ${newPin}`, 'INFO');
                
                // Update dashboard state
                dashboardState[dashboard].pin = newPin;
                dashboardState[dashboard].value = 0;
                
                // Reset the dashboard display
                updateDashboardDisplay(newPin, 0);
                
                // Update active pins list
                updateActivePinsList();
                
                // Update sensor pin options (exclude new PWM pin)
                updateSensorPinOptions();
                
                // Stop PWM on old pin
                setPWM(oldPin, 0);
            });
        });

        // Sensor pin selector handlers
        document.querySelectorAll('.sensor-selector').forEach(selector => {
            selector.addEventListener('change', (e) => {
                const sensor = e.target.dataset.sensorPin;
                const newPin = parseInt(e.target.value);
                const oldPin = sensorState[sensor].pin;
                
                log(`Sensor ${sensor}: Changed from GPIO ${oldPin} to GPIO ${newPin}`, 'INFO');
                
                // Disable old sensor first
                if (sensorState[sensor].enabled) {
                    disableSensor(sensor);
                }
                
                // Update sensor state
                sensorState[sensor].pin = newPin;
                sensorState[sensor].pulses = 0;
                sensorState[sensor].rate = 0;
                sensorState[sensor].lastPulse = null;
                
                // Reset display
                updateSensorDisplay(sensor, 0, 0, null);
                
                // Update active sensors list
                updateActiveSensorsList();
                
                // Update PWM pin options (exclude new sensor pin)
                updatePWMPinOptions();
            });
        });

        // Sensor enable/disable handlers
        document.querySelectorAll('.sensor-enable').forEach(button => {
            button.addEventListener('click', (e) => {
                const sensor = e.target.dataset.enableSensor;
                
                if (sensorState[sensor].enabled) {
                    disableSensor(sensor);
                } else {
                    enableSensor(sensor);
                }
            });
        });

        // Sensor reset handlers
        document.querySelectorAll('.sensor-reset').forEach(button => {
            button.addEventListener('click', (e) => {
                const sensor = e.target.dataset.resetSensor;
                resetSensor(sensor);
            });
        });

        // Global sensor control handlers
        document.getElementById('resetAllSensors').addEventListener('click', () => {
            for (let sensor in sensorState) {
                resetSensor(sensor);
            }
            log('All sensor counters reset', 'INFO');
        });

        document.getElementById('enableAllSensors').addEventListener('click', () => {
            for (let sensor in sensorState) {
                if (!sensorState[sensor].enabled) {
                    enableSensor(sensor);
                }
            }
            log('All sensors enabled', 'INFO');
        });

        document.getElementById('disableAllSensors').addEventListener('click', () => {
            for (let sensor in sensorState) {
                if (sensorState[sensor].enabled) {
                    disableSensor(sensor);
                }
            }
            log('All sensors disabled', 'INFO');
        });

        // Preset button handlers
        document.querySelectorAll('.preset-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const dashboard = e.target.dataset.preset;
                const value = parseInt(e.target.dataset.value);
                const pin = dashboardState[dashboard].pin;
                
                log(`Preset ${Math.round((value/255)*100)}% applied to Dashboard ${dashboard} (GPIO ${pin})`, 'INFO');
                
                // Update slider and display
                const slider = document.querySelector(`[data-slider="${dashboard}"]`);
                if (slider) {
                    slider.value = value;
                }
                
                dashboardState[dashboard].value = value;
                updateDashboardDisplay(pin, value);
                
                // Set PWM
                setPWM(pin, value);
            });
        });



        // RPM Controller Event Handlers
        document.getElementById('rpmSlider').addEventListener('input', (e) => {
            const rpm = parseInt(e.target.value);
            rpmController.targetRPM = rpm;
            document.getElementById('rpmInput').value = rpm;
            document.getElementById('targetRpmDisplay').textContent = rpm;
            
            // If control is active, update server immediately
            if (rpmController.active) {
                setTargetRPM(rpm);
            }
        });

        document.getElementById('rpmInput').addEventListener('input', (e) => {
            const rpm = parseInt(e.target.value) || 0;
            rpmController.targetRPM = rpm;
            document.getElementById('rpmSlider').value = rpm;
            document.getElementById('targetRpmDisplay').textContent = rpm;
            
            // If control is active, update server immediately
            if (rpmController.active) {
                setTargetRPM(rpm);
            }
        });

        document.getElementById('controlGain').addEventListener('input', (e) => {
            rpmController.gain = parseFloat(e.target.value);
            document.getElementById('gainDisplay').textContent = rpmController.gain;
            
            // Update server parameters
            updateRPMParams();
        });

        document.getElementById('rpmControlPin').addEventListener('change', (e) => {
            rpmController.controlPin = parseInt(e.target.value);
            log(`RPM Controller: Pin changed to GPIO ${rpmController.controlPin}`, 'INFO');
            
            // Update server parameters
            updateRPMParams();
        });

        document.getElementById('rpmSensorSelect').addEventListener('change', (e) => {
            rpmController.sensorNumber = parseInt(e.target.value);
            log(`RPM Controller: Sensor changed to Sensor ${rpmController.sensorNumber}`, 'INFO');
            
            // Update server parameters
            updateRPMParams();
        });

        document.getElementById('startRpmControl').addEventListener('click', startRPMControl);
        document.getElementById('stopRpmControl').addEventListener('click', stopRPMControl);

        // RPM Preset buttons
        document.getElementById('rpmPreset15').addEventListener('click', () => {
            rpmController.targetRPM = 15;
            document.getElementById('rpmSlider').value = 15;
            document.getElementById('rpmInput').value = 15;
            document.getElementById('targetRpmDisplay').textContent = 15;
            log('RPM Preset: 15 RPM selected', 'INFO');
            
            // Update server if control is active
            if (rpmController.active) {
                setTargetRPM(15);
            }
        });

        document.getElementById('rpmPreset30').addEventListener('click', () => {
            rpmController.targetRPM = 30;
            document.getElementById('rpmSlider').value = 30;
            document.getElementById('rpmInput').value = 30;
            document.getElementById('targetRpmDisplay').textContent = 30;
            log('RPM Preset: 30 RPM selected', 'INFO');
            
            // Update server if control is active
            if (rpmController.active) {
                setTargetRPM(30);
            }
        });

        document.getElementById('rpmPreset50').addEventListener('click', () => {
            rpmController.targetRPM = 50;
            document.getElementById('rpmSlider').value = 50;
            document.getElementById('rpmInput').value = 50;
            document.getElementById('targetRpmDisplay').textContent = 50;
            log('RPM Preset: 50 RPM selected', 'INFO');
            
            // Update server if control is active
            if (rpmController.active) {
                setTargetRPM(50);
            }
        });

        // Initialize
        updateActiveSensorsList();
        updateRPMDisplay();
        initializePinOptions();
        log('PWM Control Dashboard initialized', 'INFO');
        log('WebSocket connection established for real-time control', 'WEBSOCKET');

        log('Sensor Input Monitoring ready - monitoring 4 GPIO sensor inputs', 'INFO');
        log('RPM Controller ready - closed-loop feedback control with 45 pulses/rotation', 'INFO');
        log('GPIO pin conflict prevention enabled - input/output pins are managed separately', 'INFO');
    </script>
</body>
</html> 